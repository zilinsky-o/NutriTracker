<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NutriTrack - Mobile Diet Tracking App</title>
  
  <!-- Include React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Include Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Hide scrollbar for Chrome, Safari and Opera */
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    
    /* Hide scrollbar for IE, Edge and Firefox */
    .hide-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    
    /* Custom slider styles */
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 10px;
      background: #e5e7eb;
      outline: none;
    }
    
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #4F46E5;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    input[type=range]::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #4F46E5;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Add iOS-like look and feel */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #f9fafb;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation;
    }
    
    /* Prevent text selection */
    .no-select {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    // Define food categories outside the component
    const FOOD_CATEGORIES = [
      { id: 'carbs', name: 'Carbs', maxUnits: 5, color: '#E99D42', bgColor: '#FFEFD6' },
      { id: 'proteins', name: 'Proteins', maxUnits: 7, color: '#4C72B0', bgColor: '#E1EAFA' },
      { id: 'fats', name: 'Fats', maxUnits: 2, color: '#DD6E6E', bgColor: '#FBECEC' },
      { id: 'vegetables', name: 'Vegetables', maxUnits: 5, color: '#55AD7A', bgColor: '#E7F5EE' }
    ];

    // Helper to get default state for a single day
    const getDefaultDayState = () => ({
      carbs: 0,
      proteins: 0,
      fats: 0,
      vegetables: 0,
      date: new Date().toISOString().split('T')[0] // Store current date in YYYY-MM-DD format
    });

    // Cookie functions defined outside of component
    const saveToCookie = (state) => {
      try {
        const farFuture = new Date();
        farFuture.setFullYear(farFuture.getFullYear() + 100);
        document.cookie = `nutritrackState=${JSON.stringify(state)};expires=${farFuture.toUTCString()};path=/;SameSite=Strict`;
      } catch (error) {
        console.error('Error saving to cookies:', error);
      }
    };

    const loadFromCookie = () => {
      try {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'nutritrackState') {
            try {
              const savedState = JSON.parse(value);
              if (savedState && typeof savedState === 'object') {
                // Format has changed - if we have history array, great
                if (Array.isArray(savedState.history)) {
                  return savedState;
                }
                
                // If we have the old format (just tracking values), migrate to new format
                const today = new Date().toISOString().split('T')[0];
                const validState = {
                  currentDay: {
                    date: today
                  },
                  history: [
                    {
                      date: today
                    }
                  ]
                };
                
                // Migrate old values
                for (const category of FOOD_CATEGORIES) {
                  const categoryId = category.id;
                  const val = (savedState.hasOwnProperty(categoryId) && 
                    typeof savedState[categoryId] === 'number' && 
                    savedState[categoryId] >= 0) ? savedState[categoryId] : 0;
                  
                  validState.currentDay[categoryId] = val;
                  validState.history[0][categoryId] = val;
                }
                
                return validState;
              }
            } catch (error) {
              console.error('Failed to parse saved state:', error);
            }
          }
        }
      } catch (error) {
        console.error('Error loading from cookies:', error);
      }
      
      // Return default state if no valid saved state
      const defaultDay = getDefaultDayState();
      return {
        currentDay: defaultDay,
        history: [{ ...defaultDay }]
      };
    };

    // The main component with its functionality
    const NutriTrack = () => {
      // Set up state with history
      const [appState, setAppState] = React.useState(loadFromCookie());
      const [sliderValue, setSliderValue] = React.useState(0);
      const [isTouchActive, setIsTouchActive] = React.useState(false);
      const [activeButton, setActiveButton] = React.useState(null);
      const [showHistory, setShowHistory] = React.useState(false);
      
      // Shorthand for current day's unit counts
      const unitCounts = appState.currentDay;
      
      // Check if current day needs to be reset
      React.useEffect(() => {
        const today = new Date().toISOString().split('T')[0];
        
        // If the current day is not today, create a new day
        if (unitCounts.date !== today) {
          const newDay = {
            ...getDefaultDayState(),
            date: today
          };
          
          setAppState(prevState => {
            const newState = {
              currentDay: newDay,
              history: [newDay, ...prevState.history.slice(0, 6)] // Keep last 7 days
            };
            saveToCookie(newState);
            return newState;
          });
        }
      }, []);
      
      // Detect touch device
      React.useEffect(() => {
        const touchStartHandler = () => {
          setIsTouchActive(true);
          window.removeEventListener('touchstart', touchStartHandler);
        };
        
        window.addEventListener('touchstart', touchStartHandler);
        return () => {
          window.removeEventListener('touchstart', touchStartHandler);
        };
      }, []);
      
      // Event handlers
      const updateUnitCount = (categoryId, newValue) => {
        if (newValue < 0) return;
        
        setAppState(prevState => {
          // Find the history index for today (should be index 0, but let's be safe)
          const today = new Date().toISOString().split('T')[0];
          const historyIndex = prevState.history.findIndex(day => day.date === today);
          
          // Deep clone the history array
          const newHistory = [...prevState.history];
          
          // Create new current day object
          const newCurrentDay = { ...prevState.currentDay, [categoryId]: newValue };
          
          // Update today's history entry if it exists
          if (historyIndex >= 0) {
            newHistory[historyIndex] = { ...newHistory[historyIndex], [categoryId]: newValue };
          } else {
            // Add today to history if not found (shouldn't happen, but just in case)
            newHistory.unshift({ ...newCurrentDay });
          }
          
          const newState = {
            currentDay: newCurrentDay,
            history: newHistory
          };
          
          saveToCookie(newState);
          return newState;
        });
      };
      
      const incrementUnit = (categoryId) => {
        updateUnitCount(categoryId, unitCounts[categoryId] + 1);
      };

      const decrementUnit = (categoryId) => {
        if (unitCounts[categoryId] > 0) {
          updateUnitCount(categoryId, unitCounts[categoryId] - 1);
        }
      };
      
      const handleSliderChange = (e) => {
        setSliderValue(parseInt(e.target.value, 10));
        
        if (parseInt(e.target.value, 10) === 100) {
          // Reset current day but keep history
          setAppState(prevState => {
            const newCurrentDay = getDefaultDayState();
            
            // Update history for current day
            const today = newCurrentDay.date;
            const historyIndex = prevState.history.findIndex(day => day.date === today);
            const newHistory = [...prevState.history];
            
            if (historyIndex >= 0) {
              newHistory[historyIndex] = { ...newCurrentDay };
            } else {
              newHistory.unshift({ ...newCurrentDay });
            }
            
            const newState = {
              currentDay: newCurrentDay,
              history: newHistory
            };
            
            saveToCookie(newState);
            return newState;
          });
          
          setTimeout(() => {
            setSliderValue(0);
          }, 300);
        }
      };
      
      const handleTouchStart = (id, action) => {
        setActiveButton(`${id}-${action}`);
        
        if (action === 'inc') {
          incrementUnit(id);
        } else if (action === 'dec' && unitCounts[id] > 0) {
          decrementUnit(id);
        }
      };
      
      const handleTouchEnd = () => {
        setActiveButton(null);
      };
      
      const handleButtonClick = (id, action) => {
        if (isTouchActive) return;
        
        if (action === 'inc') {
          incrementUnit(id);
        } else if (action === 'dec' && unitCounts[id] > 0) {
          decrementUnit(id);
        }
      };

      const toggleHistory = () => {
        setShowHistory(!showHistory);
      };

      // Rendering functions
      const renderHalfCircles = (categoryId, maxUnits, color, bgColor, dayData = unitCounts) => {
        const currentUnits = dayData[categoryId] || 0;
        const isExceeded = currentUnits > maxUnits;
        const fullUnits = isExceeded ? maxUnits : currentUnits;
        const excessUnits = isExceeded ? currentUnits - maxUnits : 0;
        
        const units = Array.from({ length: maxUnits }, (_, index) => {
          const isFilled = index < fullUnits;
          
          return (
            <div 
              key={`unit-${index}`} 
              className="w-5 h-5 rounded-l-full"
              style={{ 
                backgroundColor: isFilled ? color : bgColor,
                margin: '0 2px'
              }}
            />
          );
        });
        
        const excess = Array.from({ length: excessUnits }, (_, index) => {
          return (
            <div 
              key={`excess-${index}`} 
              className="w-5 h-5 rounded-l-full"
              style={{ 
                backgroundColor: '#FF3B30',
                margin: '0 2px'
              }}
            />
          );
        });
        
        return [...units, ...excess];
      };

      // Formatting a date for display
      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (dateStr === today.toISOString().split('T')[0]) {
          return 'Today';
        } else if (dateStr === yesterday.toISOString().split('T')[0]) {
          return 'Yesterday';
        } else {
          return date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        }
      };

      return (
        <div className="flex flex-col min-h-screen max-w-md mx-auto p-4 bg-white shadow-lg sm:my-4 sm:rounded-xl no-select">
          <header className="mb-6 text-center">
            <h1 className="text-2xl font-bold text-gray-800">NutriTrack</h1>
            <p className="text-gray-600 text-sm">Track your daily food intake</p>
            <div className="flex justify-center mt-2">
              <button 
                onClick={toggleHistory}
                className="px-4 py-1 text-sm bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors"
              >
                {showHistory ? 'Hide History' : 'Show History'}
              </button>
            </div>
          </header>
          
          <main className="flex-grow">
            {!showHistory ? (
              // Today's tracking
              FOOD_CATEGORIES.map(category => {
                const currentUnits = unitCounts[category.id];
                const isExceeded = currentUnits > category.maxUnits;
                const isMaxed = currentUnits === category.maxUnits;
                
                let labelColor = 'text-gray-700';
                if (isExceeded) {
                  labelColor = 'text-red-500';
                } else if (isMaxed) {
                  labelColor = 'text-blue-500';
                }
                
                return (
                  <div key={category.id} className="mb-4 bg-white rounded-lg p-3 shadow-sm border border-gray-100">
                    <div className="flex justify-between items-center mb-2">
                      <h2 className={`text-lg font-semibold ${labelColor}`}>
                        {category.name} ({currentUnits}/{category.maxUnits})
                      </h2>
                      <div className="flex space-x-2">
                        <button 
                          onTouchStart={() => handleTouchStart(category.id, 'dec')}
                          onTouchEnd={handleTouchEnd}
                          onClick={() => handleButtonClick(category.id, 'dec')}
                          disabled={currentUnits <= 0}
                          className={`w-12 h-12 flex items-center justify-center text-lg font-bold rounded-full focus:outline-none transition-colors duration-150 ${
                            activeButton === `${category.id}-dec` 
                              ? 'bg-gray-300 text-gray-700' 
                              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          } disabled:opacity-40`}
                          aria-label={`Decrease ${category.name}`}
                        >
                          -
                        </button>
                        <button 
                          onTouchStart={() => handleTouchStart(category.id, 'inc')}
                          onTouchEnd={handleTouchEnd}
                          onClick={() => handleButtonClick(category.id, 'inc')}
                          className={`w-12 h-12 flex items-center justify-center text-lg font-bold rounded-full focus:outline-none transition-colors duration-150 ${
                            activeButton === `${category.id}-inc` 
                              ? 'bg-gray-300 text-gray-700' 
                              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                          aria-label={`Increase ${category.name}`}
                        >
                          +
                        </button>
                      </div>
                    </div>
                    
                    <div className="flex flex-wrap space-x-1 py-2 hide-scrollbar">
                      {renderHalfCircles(category.id, category.maxUnits, category.color, category.bgColor)}
                    </div>
                  </div>
                );
              })
            ) : (
              // History view
              <div className="space-y-4">
                {appState.history.map((day, index) => (
                  <div key={day.date} className="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
                    <h3 className="font-medium text-gray-800 mb-2">
                      {formatDate(day.date)}
                    </h3>
                    
                    <div className="space-y-3">
                      {FOOD_CATEGORIES.map(category => (
                        <div key={`${day.date}-${category.id}`} className="flex items-center">
                          <div className="w-24 text-sm text-gray-600">{category.name}</div>
                          <div className="flex-grow flex flex-wrap space-x-1">
                            {renderHalfCircles(category.id, category.maxUnits, category.color, category.bgColor, day)}
                          </div>
                          <div className="w-12 text-right text-sm font-medium" style={{ color: category.color }}>
                            {day[category.id] || 0}/{category.maxUnits}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
                
                {appState.history.length === 0 && (
                  <div className="text-center text-gray-500 py-6">
                    No history data available yet
                  </div>
                )}
              </div>
            )}
          </main>
          
          {!showHistory && (
            <footer className="mt-4 mb-4">
              <div className="bg-gray-100 p-4 rounded-lg shadow-inner">
                <p className="text-center text-gray-600 mb-3 text-sm">Slide to reset today's tracking</p>
                <div className="relative">
                  <input
                    type="range"
                    min="0"
                    max="100"
                    value={sliderValue}
                    onChange={handleSliderChange}
                    className="w-full h-8 rounded-full outline-none"
                    style={{
                      background: `linear-gradient(to right, #e5e7eb 0%, #e5e7eb ${sliderValue}%, #e5e7eb ${sliderValue}%, #e5e7eb 100%)`,
                    }}
                  />
                  <div 
                    className="absolute top-0 left-0 h-8 rounded-full pointer-events-none"
                    style={{
                      width: `${sliderValue}%`,
                      background: sliderValue > 95 ? '#4F46E5' : '#9CA3AF',
                      transition: 'background-color 0.2s ease'
                    }}
                  />
                </div>
                <p className="text-center text-xs text-gray-500 mt-2">
                  {sliderValue > 95 ? 'Release to reset' : 'Slide all the way to reset'}
                </p>
              </div>
            </footer>
          )}
          
          <div className="text-center text-xs text-gray-400 mt-4">
            NutriTrack v1.2.0
          </div>
        </div>
      );
    };

    // Mount the app with explicit error handling
    try {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<NutriTrack />);
    } catch (error) {
      console.error('Error rendering app:', error);
      document.getElementById('root').innerHTML = `
        <div style="text-align: center; margin-top: 40px; color: #666;">
          <h2>There was an error loading NutriTrack</h2>
          <p>${error.message}</p>
          <p>Please try refreshing the page.</p>
        </div>
      `;
    }
  </script>
</body>
</html>
